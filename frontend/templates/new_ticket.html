{% extends "base.html" %}

{% block title %}Support Chat - IT Support Portal{% endblock %}

{% block extra_css %}
<style>
    #chat-container {
        height: 70vh;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1.25rem;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .message {
        margin-bottom: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        max-width: 85%;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        line-height: 1.5;
    }
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
    }
    .bot-message {
        background-color: #ffffff;
        color: #212529;
        margin-right: auto;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 0.25rem;
    }
    .bot-message .alert {
        margin-bottom: 0;
        padding: 0.75rem 1rem;
    }
    .bot-message .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    #message-input {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    #send-button {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Support Chat</h2>
</div>

<div class="card">
    <div class="card-body p-0">
        <div id="chat-container">
            <div class="message bot-message">
                Hello! I'm your support assistant. How can I help you today?
            </div>
        </div>
        
        <div class="input-group p-3 border-top">
            <input type="text" id="message-input" class="form-control" placeholder="Type your message..." autofocus>
            <button class="btn btn-primary" type="button" id="send-button">
                <i class="bi bi-send"></i> Send
            </button>
        </div>
    </div>
</div>

<script>
    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    
    // Handle send button click
    sendButton.addEventListener('click', sendMessage);
    
    // Handle Enter key press
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, 'user');
        messageInput.value = '';
        
        // Send to server
        fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                user_id: '{{ current_user.id if current_user.is_authenticated else "guest" }}'
            })
        })
        .then(async response => {
            const responseData = await response.json().catch(() => ({}));
            
            if (!response.ok) {
                // Handle HTTP error status codes
                const errorMsg = responseData.error || `HTTP error! status: ${response.status}`;
                throw new Error(errorMsg);
            }
            
            console.log('Received data:', responseData); // Debug log
            
            // Extract the agent response from the response data
            const data = responseData.agent_response || responseData;
            
            // Handle the response from the agent
            if (data && typeof data === 'object') {
                // If we have orders data, format and display it
                if (data.orders && Array.isArray(data.orders) && data.orders.length > 0) {
                    let ordersHtml = `
                        <div class="alert alert-info">
                            <i class="bi bi-list-ul me-2"></i>
                            <strong>Your Orders</strong>
                            <div class="mt-2">
                    `;
                    
                    data.orders.forEach((order, index) => {
                        ordersHtml += `
                            <div class="mb-3 p-2 border rounded">
                                <div class="d-flex justify-content-between">
                                    <strong>Order #${order.id || 'N/A'}</strong>
                                    <span class="badge bg-${order.status === 'cancelled' ? 'danger' : 'success'}">
                                        ${order.status || 'N/A'}
                                    </span>
                                </div>
                                <div>${order.product || 'Unknown Product'}</div>
                                <div>Amount: $${parseFloat(order.amount || 0).toFixed(2)}</div>
                                <small class="text-muted">Date: ${order.date || 'N/A'}</small>
                                ${order.shipping_address ? 
                                    `<div class="mt-1"><small>Shipping: ${order.shipping_address}</small></div>` : ''}
                            </div>
                        `;
                    });
                    
                    ordersHtml += `
                            </div>
                            ${data.total_orders ? 
                                `<div class="mt-2"><strong>Total Orders:</strong> ${data.total_orders}</div>` : ''}
                        </div>
                    `;
                    
                    const ordersMsg = document.createElement('div');
                    ordersMsg.innerHTML = ordersHtml;
                    chatContainer.appendChild(ordersMsg);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    return;
                }
                
                // If there's an error, show it
                if (data.error || (data.response && data.response.includes('error'))) {
                    const errorMsg = data.error || data.response || 'An unknown error occurred';
                    throw new Error(errorMsg);
                }
                
                // If we have a response, display it
                if (data.response) {
                    // Check if this is a successful order placement
                    if (data.success && data.response.includes('successfully placed') && data.details) {
                        const orderMsg = document.createElement('div');
                        orderMsg.innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <strong>Order Successful!</strong>
                                <div class="mt-2">${data.response}</div>
                                <div class="mt-2">
                                    <small class="text-muted d-block">Order #${data.details.order_id || 'N/A'}</small>
                                    ${data.details.product_name ? `<small class="text-muted d-block">Product: ${data.details.product_name}</small>` : ''}
                                    ${data.details.amount ? `<small class="text-muted d-block">Amount: $${parseFloat(data.details.amount).toFixed(2)}</small>` : ''}
                                    ${data.details.status ? `<small class="text-muted d-block">Status: ${data.details.status}</small>` : ''}
                                </div>
                            </div>
                        `;
                        chatContainer.appendChild(orderMsg);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        return;
                    }
                    
                    // For order confirmations with details
                    if (data.details) {
                        // Handle replacement orders
                        if (data.details.replacement_order_id) {
                            const replacementMsg = document.createElement('div');
                            replacementMsg.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="bi bi-arrow-repeat me-2"></i>
                                    <strong>Replacement Order Confirmed!</strong>
                                    <div class="mt-2">${data.response || 'Your replacement order has been processed.'}</div>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Replacement Order #${data.details.replacement_order_id}</small>
                                        <small class="text-muted d-block">Status: ${data.details.status || 'Processing'}</small>
                                    </div>
                                </div>
                            `;
                            chatContainer.appendChild(replacementMsg);
                        } 
                        // Handle new order confirmations
                        else if (data.details.order_id) {
                            const orderMsg = document.createElement('div');
                            orderMsg.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="bi bi-box-seam me-2"></i>
                                    <strong>Order Confirmed!</strong>
                                    <div class="mt-2">${data.response || 'Your order has been placed successfully.'}</div>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Order #${data.details.order_id}</small>
                                        <small class="text-muted d-block">Product: ${data.details.product_name || 'N/A'}</small>
                                        <small class="text-muted d-block">Amount: $${parseFloat(data.details.amount || 0).toFixed(2)}</small>
                                        <small class="text-muted d-block">Status: ${data.details.status || 'Pending'}</small>
                                    </div>
                                </div>
                            `;
                            chatContainer.appendChild(orderMsg);
                        }
                        // Handle other types of details
                        else {
                            addMessage(data.response, 'bot');
                        }
                    } else {
                        // Regular response
                        addMessage(data.response, 'bot');
                    }
                } 
                // If no response but we have success and details, format a response
                else if (data.details) {
                    addMessage(JSON.stringify(data.details, null, 2), 'bot');
                } 
                // Handle search results
                else if (data.results && data.success) {
                    let searchResults = document.createElement('div');
                    searchResults.className = 'search-results';
                    
                    // Add the answer if available
                    if (data.answer) {
                        const answerDiv = document.createElement('div');
                        answerDiv.className = 'alert alert-info';
                        answerDiv.innerHTML = `<i class="bi bi-info-circle me-2"></i>${data.answer}`;
                        searchResults.appendChild(answerDiv);
                    }
                    
                    // Add each search result
                    data.results.forEach((result, index) => {
                        if (result.title && result.content) {
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'card mb-2';
                            resultDiv.innerHTML = `
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <a href="${result.url}" target="_blank" class="text-decoration-none">
                                            ${result.title}
                                        </a>
                                    </h6>
                                    <p class="card-text small text-muted">
                                        ${result.content.substring(0, 200)}${result.content.length > 200 ? '...' : ''}
                                    </p>
                                    <a href="${result.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        Read more
                                    </a>
                                </div>
                            `;
                            searchResults.appendChild(resultDiv);
                        }
                    });
                    
                    chatContainer.appendChild(searchResults);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            } else {
                // Handle case where data is not an object
                addMessage('Received an invalid response from the server.', 'bot');
                console.error('Invalid response data:', data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // More specific error messages based on error type
            let errorMessage = 'Sorry, there was an error processing your message. ';
            
            if (error.message.includes('Failed to fetch')) {
                errorMessage += 'Unable to connect to the server. Please check your internet connection.';
            } else if (error.message.includes('401') || error.message.includes('403')) {
                errorMessage += 'Authentication error. Please refresh the page and log in again.';
            } else if (error.message.includes('timeout') || error.message.includes('Timeout')) {
                errorMessage += 'The request timed out. Please try again.';
            } else if (error.message) {
                // Use the error message from the server if available
                errorMessage = error.message;
            } else {
                errorMessage += 'Please try again later.';
            }
            
            // Add the error message to the chat
            addMessage(errorMessage, 'bot');
            
            // Log the full error for debugging
            console.error('Full error:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
        });
    }
    
    function addMessage(content, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(sender + '-message');
        
        // Check if the content contains HTML tags
        if (/<[a-z][\s\S]*>/i.test(content)) {
            // If it's HTML, use innerHTML
            messageDiv.innerHTML = content;
        } else {
            // Otherwise, treat as plain text
            messageDiv.textContent = content;
        }
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
</script>
{% endblock %} 